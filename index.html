<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forever Story</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }

    h1 {
      margin-bottom: 1rem;
      color: #4a2f5b;
      text-shadow: 1px 1px 2px #fff5f7;
      user-select: none;
    }

    #story {
      width: 100%;
      max-width: 600px;
      height: 350px;
      background: white;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      overflow-y: auto;
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      font-size: 1.1rem;
      line-height: 1.5;
      white-space: pre-wrap;
      margin-bottom: 1rem;
      border: 3px solid #a37c99;
    }

    .sentence {
      margin: 0.25rem 0;
    }

    .sentence.latest {
      font-weight: 700;
      color: #7b3f69;
      background: #f7d9e3;
      padding: 0.2rem 0.4rem;
      border-radius: 6px;
      box-shadow: 0 0 5px #c37a9daa;
    }

    #input-container {
      display: flex;
      max-width: 600px;
      width: 100%;
      gap: 0.75rem;
    }

    #sentence-input {
      flex-grow: 1;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      border: 2px solid #a37c99;
      font-size: 1rem;
      box-shadow: inset 0 2px 5px #f0d6e3;
      resize: vertical;
      min-height: 50px;
      transition: border-color 0.3s;
    }
    #sentence-input:focus {
      border-color: #7b3f69;
      outline: none;
      box-shadow: 0 0 6px #c37a9d;
    }

    #add-button {
      background-color: #7b3f69;
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 0 1.5rem;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background-color 0.25s;
      user-select: none;
    }
    #add-button:hover {
      background-color: #a37c99;
    }
    #add-button:active {
      background-color: #5a2e4a;
    }

    @media (max-width: 650px) {
      body {
        padding: 1rem;
      }
      #story, #input-container {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

  <h1>The Never-Ending Story</h1>

  <div id="story"></div>

  <div id="input-container">
    <textarea
      id="sentence-input"
      placeholder="Add your sentence here..."
      rows="2"
      maxlength="300"
    ></textarea>
    <button id="add-button">Add Sentence</button>
  </div>

  <script>
    const storyEl = document.getElementById("story");
    const inputEl = document.getElementById("sentence-input");
    const addButton = document.getElementById("add-button");

    // New base API URL
    const API_BASE_URL = "https://api2.longeststoryever.xyz/webhook/v1";

    // Store story sentences here
    let story = [];

    // Render the story sentences in the UI
    function renderStory() {
      storyEl.innerHTML = "";
      story.forEach((sentence, idx) => {
        const p = document.createElement("p");
        p.textContent = sentence;
        p.classList.add("sentence");
        if (idx === story.length - 1) {
          p.classList.add("latest");
        }
        storyEl.appendChild(p);
      });
      storyEl.scrollTop = storyEl.scrollHeight;
    }

    // Fetch the whole story from the API on page load
    async function fetchFullStory() {
      try {
        const response = await fetch(`${API_BASE_URL}/story`);
        if (!response.ok) throw new Error(`Failed to fetch story: ${response.status}`);

        // Assuming API returns JSON array of sentences, adjust if it's plain text
        const data = await response.json();

        if (Array.isArray(data)) {
          story = data;
        } else if (typeof data === "string") {
          // If it's a string with sentences separated by newlines, split it:
          story = data.split('\n').filter(s => s.trim() !== '');
        } else {
          console.warn("Unexpected story format from API", data);
          story = ["(No story loaded)"];
        }
        renderStory();
      } catch (error) {
        console.error(error);
        story = ["(Failed to load story from server)"];
        renderStory();
      }
    }

    // Send new sentence to the backend API
    async function sendToAPI(sentence) {
      try {
        const response = await fetch(API_BASE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ sentence })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        console.log("Sentence sent to API successfully:", data);
      } catch (error) {
        console.error("Failed to send sentence to API:", error);
        alert("⚠️ Warning: Could not send your sentence to the server!");
      }
    }

    // Add sentence to story locally and send to API
    async function addSentence() {
      const text = inputEl.value.trim();
      if (!text) return alert("Hey, please type a sentence before adding!");

      story.push(text);
      renderStory();
      inputEl.value = "";

      await sendToAPI(text);
    }

    // Event listeners
    addButton.addEventListener("click", addSentence);

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        addSentence();
      }
    });

    // Fetch story on page load
    fetchFullStory();
  </script>

</body>
</html>
