const storyEl = document.getElementById("story");
const inputEl = document.getElementById("sentence-input");
const addButton = document.getElementById("add-button");

// New base API URL
const API_BASE_URL = "https://api2.longeststoryever.xyz/webhook/v1";

// Store story sentences here
let story = [];

// Render the story sentences in the UI
function renderStory() {
  storyEl.innerHTML = "";
  story.forEach((sentence, idx) => {
    const p = document.createElement("p");
    p.textContent = sentence;
    p.classList.add("sentence");
    if (idx === story.length - 1) {
      p.classList.add("latest");
    }
    storyEl.appendChild(p);
  });
  storyEl.scrollTop = storyEl.scrollHeight;
}

// Fetch the whole story from the API on page load
async function fetchFullStory() {
  try {
    const response = await fetch(`${API_BASE_URL}/story`);
    if (!response.ok) throw new Error(`Failed to fetch story: ${response.status}`);
    
    // Assuming API returns JSON array of sentences, adjust if it's plain text
    const data = await response.json();

    if (Array.isArray(data)) {
      story = data;
    } else if (typeof data === "string") {
      // If it's a string with sentences separated by newlines, split it:
      story = data.split('\n').filter(s => s.trim() !== '');
    } else {
      console.warn("Unexpected story format from API", data);
      story = ["(No story loaded)"];
    }
    renderStory();
  } catch (error) {
    console.error(error);
    story = ["(Failed to load story from server)"];
    renderStory();
  }
}

// Send new sentence to the backend API
async function sendToAPI(sentence) {
  try {
    const response = await fetch(API_BASE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ sentence })
    });

    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }

    const data = await response.json();
    console.log("Sentence sent to API successfully:", data);
  } catch (error) {
    console.error("Failed to send sentence to API:", error);
    alert("⚠️ Warning: Could not send your sentence to the server!");
  }
}

// Add sentence to story locally and send to API
async function addSentence() {
  const text = inputEl.value.trim();
  if (!text) return alert("Hey, please type a sentence before adding!");

  story.push(text);
  renderStory();
  inputEl.value = "";

  await sendToAPI(text);
}

// Event listeners
addButton.addEventListener("click", addSentence);

inputEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    addSentence();
  }
});

// Fetch story on page load
fetchFullStory();
