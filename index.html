<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forever Story</title>
  <style>
    /* ... your existing styles ... */
    /* (omitted here for brevity but keep them in your file) */
  </style>
</head>
<body>

  <h1>The Never-Ending Story</h1>

  <div id="story"></div>

  <div id="input-container">
    <textarea
      id="sentence-input"
      placeholder="Add your sentence here..."
      rows="2"
      maxlength="300"
    ></textarea>
    <button id="add-button">Add Sentence</button>
  </div>

  <script>
    const storyEl = document.getElementById("story");
    const inputEl = document.getElementById("sentence-input");
    const addButton = document.getElementById("add-button");

    const API_BASE_URL = "https://api2.longeststoryever.xyz/webhook/v1";

    let story = [];

    function renderStory() {
      storyEl.innerHTML = "";
      story.forEach((sentence, idx) => {
        const p = document.createElement("p");
        p.textContent = sentence;
        p.classList.add("sentence");
        if (idx === story.length - 1) {
          p.classList.add("latest");
        }
        storyEl.appendChild(p);
      });
      storyEl.scrollTop = storyEl.scrollHeight;
    }

    async function fetchFullStory() {
      try {
        const response = await fetch(`${API_BASE_URL}/story`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({}) // sending empty object as POST body
        });

        if (!response.ok) throw new Error(`Failed to fetch story: ${response.status}`);

        const data = await response.json();

        if (Array.isArray(data)) {
          story = data;
        } else if (typeof data === "string") {
          story = data.split('\n').filter(s => s.trim() !== '');
        } else {
          console.warn("Unexpected story format from API", data);
          story = ["(No story loaded)"];
        }
        renderStory();
      } catch (error) {
        console.error(error);
        story = ["(Failed to load story from server)"];
        renderStory();
      }
    }

    async function sendToAPI(sentence) {
      try {
        const response = await fetch(API_BASE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ sentence })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        console.log("Sentence sent to API successfully:", data);
      } catch (error) {
        console.error("Failed to send sentence to API:", error);
        alert("⚠️ Warning: Could not send your sentence to the server!");
      }
    }

    async function addSentence() {
      const text = inputEl.value.trim();
      if (!text) return alert("Hey, please type a sentence before adding!");

      story.push(text);
      renderStory();
      inputEl.value = "";

      await sendToAPI(text);
    }

    addButton.addEventListener("click", addSentence);

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        addSentence();
      }
    });

    fetchFullStory();
  </script>

</body>
</html>
